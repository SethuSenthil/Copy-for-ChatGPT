(async function () {
  console.log('%cCopyGPT (Copy For ChatGPT Extension) Loaded', 'color: green; font-size: 30px');
  const currentYear = new Date().getFullYear()
  console.log(`
  - Copy Button: Enabled âœ…
  - CMD+K Hotkey: Enabled âœ…
  - Up Arrow Key: Enabled âœ…
  - âœ¨ AI plagiarism checker: Enabled âœ…

  Copyright (c) ${currentYear} Sethu Senthil
  Version: 0.3.7
  https://copygpt.sethusenthil.com
  https://sethusenthil.com
  `)

  const CHAT_TEXT_SELECTOR = '.markdown';
  const CHAT_TEXT_SELECTOR_ALL = '.markdown,.min-h-\\[20px\\]';
  const CLIPBOARD_CLASS_NAME = 'copy-to-clipboard';
  var copyUserPromptToClipboard = false;

  const showSnackbar = (message, position) => {
    const snack = document.createElement('div');
    snack.classList.add('snackbar');

    if (position) {
      //default position is bottom
      snack.classList.add(position);
    } else {
      snack.classList.add('bottom');
    }

    snack.innerText = message;
    document.body.appendChild(snack);
    snack.classList.add('show');
    setTimeout(function () {
      snack.className = snack.className.replace("show", "");
      snack.remove();
    }, 3000);
  };

  chrome.runtime.onMessage.addListener(function (response, sender, sendResponse) {
    // console.log('response', response);

    if (response.message.documents[0].average_generated_prob >= 0.5) {
      showSnackbar('This text was flagged as AI generated by plagiarism detectors, make some changes before submitting! ðŸš¨', 'top');
    } else {
      showSnackbar('Your text was not flagged by AI detectors! âœ…', 'top');
    }
  });

  const copyToClipboard = (str) => {
    chrome.runtime.sendMessage({ message: str });

    navigator.clipboard.writeText(str).then(function () {
      //console.log('Async: Copying to clipboard was successful!');
    }, function (err) {
      console.error('Async: Could not copy text: ', err);
    });
    showSnackbar('Copied to clipboard ðŸ“‹');
  };


  const intervalId = window.setInterval(async function () {
    if (!document.querySelector('#copygpt-credits')) {
      var textCenterElement = document.querySelector('.text-center');
      if (textCenterElement == null) {
        textCenterElement = document.querySelector('.text-center.text-xs');
      }
	  if (textCenterElement !== null) {
		textCenterElement.insertAdjacentHTML('beforeend', '&nbsp; âœ¨ <a class="underline" id="copygpt-credits" target="_blank" href="https://copygpt.sethusenthil.com/?ref=gptFooter"> Enhanced by CopyGPT</a>');
	  }
    }

    const chatContainer = document.querySelector('.flex .flex-col .items-center');

    //console.log('probing for new chat bubbles');
    const chatbubbles = chatContainer.querySelectorAll('main.w-full .border-b');
    //console.log('chatbubbles', chatbubbles);

    //check if it is a plus user
    var plusUser = (chatbubbles.length % 2 === 0) ? false : true;
	
	//check if copyUserPromptToClipboard is enabled
	chrome.storage.sync.get('copyUserPromptToClipboard', function(settings) {
	  if (settings.copyUserPromptToClipboard) {
		copyUserPromptToClipboard = true;
	  }
	});

    chatbubbles.forEach((chatbox, i) => {
      //console.log('chatbox', chatbox);
      //first chat box needs to be from user, hence all the even chat bubbles are from bot
      //plus users will have the first row as model selection
      if ((i > 0 && (i % 2 === 0) && plusUser && !copyUserPromptToClipboard) ||
        ((i + 1) % 2 === 0 && !plusUser && !copyUserPromptToClipboard) ||
		(copyUserPromptToClipboard && ((i > 0 && plusUser) || !plusUser))) {
			
		var addAfter;
		var text;
		
		//Check if showing copy to clipboard for user prompts 
		if (copyUserPromptToClipboard) {
			
			//it is a chat box from bot
			addAfter = chatbox.querySelector(CHAT_TEXT_SELECTOR);
			
			if (addAfter===null) {
				
				//chatbox from user
				var addAfterAll = chatbox.querySelectorAll(CHAT_TEXT_SELECTOR_ALL);
				if (addAfterAll!=null && addAfterAll.length > 0) {
					addAfter = addAfterAll[0];
				}
			}
			
		} else {
			//it is a chat box from bot
			addAfter = chatbox.querySelector(CHAT_TEXT_SELECTOR);
		}
		
        if (chatbox.querySelector(`.${CLIPBOARD_CLASS_NAME}`) === null) {
					
		  //TODO: to check if ChatGPT is done typing check .result-streaming class exists in chatbox

		  addAfter.insertAdjacentHTML('afterend', `<div style="display: flex; align-items: center; color: lightslategray;" class="copy-to-clipboard">
		  <p>Copy to Clipboard</p> <img src="https://copygpt.sethusenthil.com/cdn/clipboard-emoji.webp" alt="clipboard emoji" class="emoji"/>
		  </div>`);
		  chatbox.querySelector(`.${CLIPBOARD_CLASS_NAME}`).addEventListener('click', function () {
  
			text = addAfter.innerText;
            copyToClipboard(text);

          });
        }
      }
    });

    if (chatContainer.getAttribute('listener-injected') !== 'true') {

      //console.log('setting event listener cause its not already there')
      document.addEventListener('keydown', function (event) {
        const chatContainer = document.querySelector('.flex .flex-col .items-center');

        // check for CTRL+K on Windows or CMD+K on Mac
        if ((event.ctrlKey || event.metaKey) && event.keyCode === 75) {
          //console.log('Copy Shortcut Pressed');

          const chatbubbles = chatContainer.querySelectorAll('main.w-full .border-b');

          //check if it is a plus user
          var plusUser = (chatbubbles.length % 2 === 0) ? false : true;

          if (((chatbubbles.length % 2 === 0) && !plusUser) ||
            ((chatbubbles.length % 2 === 1) && plusUser)) {
            //if last chat is from bot
            const lastChatBubble = chatbubbles[chatbubbles.length - 1];
            const text = lastChatBubble.querySelector(CHAT_TEXT_SELECTOR).innerText
            copyToClipboard(text);
          }

        }
        chatContainer.setAttribute('listener-injected', 'true');
      });

      const textarea = document.querySelector('textarea');

	  if (textarea.getAttribute('listener-injected') !== 'true') {
			textarea.setAttribute('listener-injected', 'true');
			textarea.addEventListener('keydown', function (event) {

			// CTRL+UP or CMD+UP to navigate through user previous prompts
			if ((event.ctrlKey || event.metaKey) && (event.key === 'ArrowUp')) {
			
			  const chatContainer = document.querySelector('.flex .flex-col .items-center');		
			  const chatbubbles = chatContainer.querySelectorAll('main.w-full .border-b');
				
			  if (chatbubbles.length > 0) {
					let lastSetIndex = chatContainer.getAttribute('last-set-index') ?? chatbubbles.length;
					
					if (event.key === 'ArrowUp') {
						lastSetIndex-=2;

						//check if it is a plus user
						var plusUser = (chatbubbles.length % 2 === 0) ? false : true;
						var firstIndex = plusUser ? 1 : 0
						
						if (lastSetIndex < firstIndex) {
						  lastSetIndex = chatbubbles.length-2;
						}
					}
					
					const lastChatBubble = chatbubbles[lastSetIndex];
					var text = lastChatBubble.innerText

					text = text.replace('\n\nCopy to Clipboard','');
					textarea.value = text;
					
					// Expand the textarea if prompt is multiline otherwise keeps default size
					if (text.includes('\n')) {
						textarea.setAttribute('style','max-height: 200px; height: 264px;');
					} else {
						textarea.setAttribute('style', 'max-height: 200px; height: 24px; overflow-y: hidden;');
					}
					
					chatContainer.setAttribute('last-set-index', lastSetIndex);
				}
			}
		  });
	  }
	}
	
  }, 1000);

})();

